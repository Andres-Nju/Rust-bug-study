io: make duplex stream cooperative (#4470) (#4478)

